<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Drill: Gerunds (Editable)</title>
    <style>
        /* --- 共通変数定義 --- */
        :root {
            --text-main: #333333;
            --text-white: #ffffff;
            --success-color: #28a745;
            --error-color: #dc3545;
            --bg-color: #f9f9f9;
            --card-bg: #ffffff;
            --stamp-color: #d32f2f;
            --color-select-bg: #E1F5FE; --color-select-border: #4FC3F7; --color-select-dark: #0288D1;
            --color-sort-bg: #FFF3E0;   --color-sort-border: #FFB74D;   --color-sort-dark: #F57C00;
            --color-input-bg: #E8F5E9;  --color-input-border: #81C784;  --color-input-dark: #388E3C;
            --color-full-bg: #FCE4EC;   --color-full-border: #F06292;   --color-full-dark: #C2185B;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-text-size-adjust: 100%;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 30px;
            min-height: 60vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #menu-screen { text-align: center; display: flex; flex-direction: column; gap: 20px; }
        .menu-title { font-size: 2rem; color: #555; margin-bottom: 10px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; padding: 10px; }
        .menu-btn-wrapper { position: relative; }
        .menu-btn { width: 100%; height: 100%; padding: 25px 10px; font-size: 1.2rem; border: 2px solid transparent; border-radius: 15px; cursor: pointer; transition: all 0.2s; font-weight: bold; color: var(--text-main); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .menu-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .menu-sub { font-size: 0.8rem; font-weight: normal; margin-top: 5px; opacity: 0.8; }
        .btn-select { background-color: var(--color-select-bg); border-color: var(--color-select-border); }
        .btn-select:hover { background-color: var(--color-select-border); color: var(--text-white); }
        .btn-sort { background-color: var(--color-sort-bg); border-color: var(--color-sort-border); }
        .btn-sort:hover { background-color: var(--color-sort-border); color: var(--text-white); }
        .btn-input { background-color: var(--color-input-bg); border-color: var(--color-input-border); }
        .btn-input:hover { background-color: var(--color-input-border); color: var(--text-white); }
        .btn-full { background-color: var(--color-full-bg); border-color: var(--color-full-border); }
        .btn-full:hover { background-color: var(--color-full-border); color: var(--text-white); }

        .gj-badge { 
            position: absolute; top: -15px; right: -15px; background: var(--stamp-color); color: white; 
            width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid white; 
            transform: rotate(15deg) scale(0); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 10; 
        }
        .gj-badge.earned { transform: rotate(15deg) scale(1); }

        #game-screen, #result-screen { display: none; flex-direction: column; height: 100%; flex-grow: 1; }
        header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        .mode-badge { display: inline-block; color: white; padding: 6px 15px; border-radius: 20px; font-weight: bold; margin-bottom: 5px; font-size: 1.1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .theme-select { background-color: var(--color-select-dark); }
        .theme-sort { background-color: var(--color-sort-dark); }
        .theme-input { background-color: var(--color-input-dark); }
        .theme-full { background-color: var(--color-full-dark); }
        .progress-bar-bg { width: 100%; height: 10px; background: #eee; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--success-color); width: 0%; transition: width 0.3s ease; }
        .back-btn { background: #999; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: background 0.2s; }

        .question-area { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 30px; min-height: 50px; flex-wrap: wrap; }
        .jp-text { font-size: 1.6rem; font-weight: bold; color: #444; margin: 0; }
        .btn-reset { font-size: 0.9rem; padding: 5px 12px; background-color: #90A4AE; color: white; border: none; border-radius: 15px; cursor: pointer; display: none; }

        .interaction-area { background: #fff; border: 2px dashed #ddd; border-radius: 12px; padding: 20px; min-height: 80px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; font-size: 1.4rem; line-height: 2.2rem; transition: border-color 0.3s; position: relative; z-index: 2; }
        .theme-border-select { border-color: var(--color-select-border); background-color: #fafdff; }
        .theme-border-sort { border-color: var(--color-sort-border); background-color: #fffaf5; }
        .theme-border-input { border-color: var(--color-input-border); background-color: #f5fbf6; }
        .theme-border-full { border-color: var(--color-full-border); background-color: #fff5f8; }
        
        /* 選択モードの入力欄をボタンのように見せる */
        .gap-input-clickable { cursor: pointer; transition: background 0.2s; }
        .gap-input-clickable:hover { background-color: #f0f0f0; }

        .word-chip { padding: 10px 18px; font-size: 1.2rem; background: #fff; border: 2px solid #ccc; border-radius: 25px; cursor: pointer; user-select: none; touch-action: manipulation; box-shadow: 0 2px 0px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .word-chip:active { transform: translateY(2px); box-shadow: none; }
        .word-chip.selected { opacity: 0.3; pointer-events: none; border-style: dashed; }
        .options-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 10px; z-index: 2; }
        
        input[type="text"] { font-size: 1.4rem; padding: 5px 10px; border: 2px solid #ddd; border-radius: 8px; text-align: center; color: var(--text-main); }
        .gap-input { min-width: 40px; border: none; border-bottom: 3px solid #888; background: transparent; color: var(--color-select-dark); font-weight: bold; text-align: center; padding: 0 5px; height: 1.8rem; }
        
        .error-mark { color: var(--error-color); font-weight: bold; font-size: 1.2rem; margin-left: 3px; animation: shake 0.3s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-2px); } 75% { transform: translateX(2px); } }

        .action-area { display:flex; justify-content:center; align-items:center; gap:10px; margin-top: auto; height: 70px; z-index: 2; }
        .btn-check, .btn-next, .btn-hint { font-size: 1.2rem; padding: 12px 30px; border: none; border-radius: 50px; cursor: pointer; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.15); font-weight: bold; }
        .btn-check { background: var(--text-main); }
        .btn-next { background: var(--success-color); display: none; }
        .btn-hint { background-color: #FFCA28; color: #333; display: none; }

        .feedback-msg { font-size: 1.5rem; font-weight: bold; height: 40px; margin-bottom: 10px; text-align: center; }
        .correct-text { color: var(--success-color); }
        .wrong-text { color: var(--error-color); }
        
        #result-screen { align-items: center; justify-content: center; text-align: center; }
        .score-display { font-size: 3rem; font-weight: bold; margin-bottom: 30px; }
        .stamp { font-family: "Impact", sans-serif; font-size: 3.5rem; color: var(--stamp-color); border: 6px solid var(--stamp-color); border-radius: 15px; padding: 10px 20px; text-transform: uppercase; transform: rotate(-10deg); opacity: 0; }
        .stamp.visible { animation: stampThud 0.4s forwards; }
        @keyframes stampThud { 0% { transform: rotate(-10deg) scale(2.5); opacity: 0; } 100% { transform: rotate(-10deg) scale(1); opacity: 1; } }

        #confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .confetti-piece { position: absolute; width: 10px; height: 10px; animation: explode ease-out forwards; }
    </style>
</head>
<body>

<div id="confetti-container"></div>

<div class="container">
    <div id="menu-screen">
        <h1 class="menu-title">動名詞トレーニング</h1>
        <div class="menu-grid">
            <div class="menu-btn-wrapper">
                <button class="menu-btn btn-select" onclick="startGame(0)">1. 空欄選択<span class="menu-sub">Select Gap</span></button>
                <div class="gj-badge" id="badge-0">GJ!!</div>
            </div>
            <div class="menu-btn-wrapper">
                <button class="menu-btn btn-sort" onclick="startGame(1)">2. 並べ替え<span class="menu-sub">Reorder</span></button>
                <div class="gj-badge" id="badge-1">GJ!!</div>
            </div>
            <div class="menu-btn-wrapper">
                <button class="menu-btn btn-input" onclick="startGame(2)">3. 空欄入力<span class="menu-sub">Type Gap</span></button>
                <div class="gj-badge" id="badge-2">GJ!!</div>
            </div>
            <div class="menu-btn-wrapper">
                <button class="menu-btn btn-full" onclick="startGame(3)">4. 全文入力<span class="menu-sub">Full Type</span></button>
                <div class="gj-badge" id="badge-3">GJ!!</div>
            </div>
        </div>
    </div>

    <div id="game-screen">
        <header>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button class="back-btn" onclick="showMenu()">Menu</button>
                <div id="modeTitle" class="mode-badge">Mode</div>
                <div style="width:60px;"></div>
            </div>
            <div class="progress-bar-bg"><div id="progressBar" class="progress-bar-fill"></div></div>
            <div id="progressText" style="margin-top:5px; color:#999; font-size:0.8rem;">Progress</div>
        </header>
        <div class="question-area">
            <div id="jpText" class="jp-text">...</div>
            <button id="resetBtn" class="btn-reset" onclick="resetReorder()">Reset</button>
        </div>
        <div id="workspace"></div>
        <div class="feedback-msg" id="feedback"></div>
        <div class="action-area">
            <button id="hintBtn" class="btn-hint" onclick="showHint()">Hint</button>
            <button id="checkBtn" class="btn-check" onclick="checkAnswer(event)">Check Answer</button>
            <button id="nextBtn" class="btn-next" onclick="nextQuestion()">Next &raquo;</button>
        </div>
    </div>

    <div id="result-screen">
        <div class="score-display" id="finalScore"></div>
        <div class="stamp-box"><div id="greatJobStamp" class="stamp">Great Job!!</div></div>
        <button class="back-btn" style="padding:15px 30px; font-size:1.1rem;" onclick="showMenu()">Back to Menu</button>
    </div>
</div>

<script>
    const rawData = [
        { id: 1, ja: "赤ちゃんは泣きやみました。", en: "The baby stopped crying." },
        { id: 2, ja: "私は昨夜その小説を読み終えました。", en: "I finished reading that novel last night." },
        { id: 3, ja: "彼女は音楽を聞くのが好きです。", en: "She is fond of listening to music." },
        { id: 4, ja: "彼は朝食をとらないで学校へ行きました。", en: "He went to school without having breakfast." },
        { id: 5, ja: "わざわざお出迎えくださってありがとうございます。", en: "Thank you for coming all the way to meet me." }
    ];

    const MODES = [
        { name: "空欄選択 (Select)", theme: "theme-select", border: "theme-border-select" },
        { name: "並べ替え (Reorder)", theme: "theme-sort", border: "theme-border-sort" },
        { name: "空欄入力 (Type Gap)", theme: "theme-input", border: "theme-border-input" },
        { name: "全文入力 (Full Type)", theme: "theme-full", border: "theme-border-full" }
    ];

    let currentModeIndex = 0, currentProblemIndex = 0, correctCount = 0, words = [], currentGaps = [], completedModes = [false, false, false, false];

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(isCorrect) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (isCorrect) {
            osc.frequency.setValueAtTime(660, audioCtx.currentTime);
            osc.frequency.setValueAtTime(880, audioCtx.currentTime + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
            osc.start(); osc.stop(audioCtx.currentTime + 0.4);
        } else {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }
    }

    function showMenu() {
        document.getElementById("menu-screen").style.display = "flex";
        document.getElementById("game-screen").style.display = "none";
        document.getElementById("result-screen").style.display = "none";
        completedModes.forEach((earned, i) => document.getElementById(`badge-${i}`).classList.toggle("earned", earned));
    }

    function startGame(modeIndex) {
        currentModeIndex = modeIndex; currentProblemIndex = 0; correctCount = 0;
        document.getElementById("menu-screen").style.display = "none";
        document.getElementById("game-screen").style.display = "flex";
        loadQuestion();
    }

    function loadQuestion() {
        const p = rawData[currentProblemIndex];
        const mode = MODES[currentModeIndex];
        words = p.en.replace(/[.,?!]/g, "").split(" ");
        currentGaps = generateGaps(words);

        document.getElementById("modeTitle").textContent = mode.name;
        document.getElementById("modeTitle").className = `mode-badge ${mode.theme}`;
        document.getElementById("progressText").textContent = `Progress: ${currentProblemIndex + 1} / ${rawData.length}`;
        document.getElementById("progressBar").style.width = `${((currentProblemIndex + 1) / rawData.length) * 100}%`;
        document.getElementById("jpText").textContent = p.ja;
        
        document.getElementById("checkBtn").style.display = "inline-block";
        document.getElementById("nextBtn").style.display = "none";
        document.getElementById("resetBtn").style.display = (currentModeIndex === 1) ? "inline-block" : "none";
        document.getElementById("hintBtn").style.display = (currentModeIndex === 2) ? "inline-block" : "none";
        document.getElementById("feedback").textContent = "";
        renderWorkspace(mode);
    }

    function generateGaps(wordList) {
        const ings = wordList.map((w, i) => w.toLowerCase().endsWith("ing") ? i : -1).filter(i => i !== -1);
        const gaps = new Set();
        if (ings.length > 0) gaps.add(ings[Math.floor(Math.random() * ings.length)]);
        while (gaps.size < Math.min(3, Math.max(2, Math.floor(wordList.length / 3)))) {
            gaps.add(Math.floor(Math.random() * wordList.length));
        }
        return Array.from(gaps).sort((a,b) => a - b);
    }

    function renderWorkspace(mode) {
        const workspace = document.getElementById("workspace");
        workspace.innerHTML = "";
        const area = document.createElement("div");
        area.className = `interaction-area ${mode.border}`;

        if (currentModeIndex === 0) {
            words.forEach((w, i) => {
                if (currentGaps.includes(i)) {
                    const input = document.createElement("input");
                    input.type = "text"; input.className = "gap-input gap-input-clickable"; input.id = `gap-${i}`;
                    input.readOnly = true; input.placeholder = "?";
                    input.style.width = `${Math.max(40, (w.length * 16) + 15)}px`;
                    // ★ 修正：クリックで「?」に戻す
                    input.onclick = function() { this.value = "?"; };
                    area.appendChild(input);
                } else {
                    const span = document.createElement("span"); span.textContent = w + " ";
                    area.appendChild(span);
                }
            });
            workspace.appendChild(area);
            const optArea = document.createElement("div"); optArea.className = "options-area";
            [...currentGaps].map(g => words[g]).sort(() => Math.random() - 0.5).forEach(opt => {
                const btn = document.createElement("button"); btn.className = "word-chip"; btn.textContent = opt;
                btn.onclick = () => fillFirstEmpty(opt);
                optArea.appendChild(btn);
            });
            workspace.appendChild(optArea);
        } else if (currentModeIndex === 1) {
            area.id = "reorder-area"; workspace.appendChild(area);
            const pool = document.createElement("div"); pool.className = "options-area"; pool.id = "reorder-pool";
            [...words].sort(() => Math.random() - 0.5).forEach(w => {
                const btn = document.createElement("button"); btn.className = "word-chip"; btn.textContent = w;
                btn.onclick = () => { if(!btn.classList.contains("selected")) {
                    const chip = document.createElement("button"); chip.className = "word-chip"; chip.textContent = w;
                    chip.onclick = () => { chip.remove(); btn.classList.remove("selected"); };
                    area.appendChild(chip); btn.classList.add("selected");
                }};
                pool.appendChild(btn);
            });
            workspace.appendChild(pool);
        } else if (currentModeIndex === 2) {
            words.forEach((w, i) => {
                if (currentGaps.includes(i)) {
                    const wrap = document.createElement("span"); wrap.className = "gap-wrapper";
                    const input = document.createElement("input"); input.type = "text"; input.className = "gap-input"; input.id = `type-gap-${i}`;
                    input.style.width = `${Math.max(40, (w.length * 16) + 15)}px`;
                    wrap.appendChild(input); area.appendChild(wrap);
                } else {
                    const span = document.createElement("span"); span.textContent = w + " ";
                    area.appendChild(span);
                }
            });
            workspace.appendChild(area);
        } else if (currentModeIndex === 3) {
            const input = document.createElement("input"); input.id = "full-input"; input.type = "text"; input.placeholder = "Type here...";
            input.onkeydown = (e) => { if(e.key === 'Enter') checkAnswer(e); };
            area.appendChild(input); workspace.appendChild(area);
        }
    }

    function fillFirstEmpty(val) {
        for (let i of currentGaps) {
            const el = document.getElementById(`gap-${i}`);
            if (el && (el.value === "" || el.value === "?")) { el.value = val; break; }
        }
    }

    function resetReorder() {
        document.getElementById("reorder-area").innerHTML = "";
        document.querySelectorAll("#reorder-pool .word-chip").forEach(b => b.classList.remove("selected"));
    }

    function showHint() {
        currentGaps.forEach(i => {
            const input = document.getElementById(`type-gap-${i}`);
            if (input && (input.value === "" || input.value !== words[i])) input.value = words[i][0];
        });
    }

    function checkAnswer(e) {
        const correctStr = rawData[currentProblemIndex].en.replace(/[.,?!]/g, "");
        let isCorrect = false;
        document.querySelectorAll(".error-mark").forEach(m => m.remove());

        if (currentModeIndex === 0) {
            isCorrect = currentGaps.every(i => document.getElementById(`gap-${i}`).value === words[i]);
        } else if (currentModeIndex === 1) {
            isCorrect = Array.from(document.getElementById("reorder-area").children).map(c => c.textContent).join(" ") === correctStr;
        } else if (currentModeIndex === 2) {
            let all = true;
            currentGaps.forEach(i => {
                const input = document.getElementById(`type-gap-${i}`);
                if (input.value.trim() !== words[i]) {
                    all = false;
                    const mark = document.createElement("span"); mark.className = "error-mark"; mark.textContent = "!";
                    input.parentElement.appendChild(mark);
                }
            });
            isCorrect = all;
        } else if (currentModeIndex === 3) {
            isCorrect = document.getElementById("full-input").value.trim().replace(/[.,?!]/g, "").toLowerCase() === correctStr.toLowerCase();
        }

        playSound(isCorrect);
        const fb = document.getElementById("feedback");
        if (isCorrect) {
            correctCount++; fb.textContent = "Great!"; fb.className = "feedback-msg correct-text";
            document.getElementById("checkBtn").style.display = "none";
            document.getElementById("nextBtn").style.display = "inline-block";
            fireConfetti();
        } else { fb.textContent = "Try again..."; fb.className = "feedback-msg wrong-text"; }
    }

    function nextQuestion() {
        currentProblemIndex++;
        if (currentProblemIndex >= rawData.length) {
            document.getElementById("game-screen").style.display = "none";
            document.getElementById("result-screen").style.display = "flex";
            document.getElementById("finalScore").textContent = `Score: ${correctCount} / ${rawData.length}`;
            if (correctCount/rawData.length >= 0.8) {
                completedModes[currentModeIndex] = true;
                setTimeout(() => document.getElementById("greatJobStamp").classList.add("visible"), 500);
            }
        } else loadQuestion();
    }

    function fireConfetti() {
        const container = document.getElementById('confetti-container');
        for (let i = 0; i < 50; i++) {
            const p = document.createElement('div'); p.className = 'confetti-piece';
            p.style.left = '50%'; p.style.top = '50%';
            p.style.backgroundColor = `hsl(${Math.random()*360}, 70%, 50%)`;
            p.style.setProperty('--tx', `${(Math.random()-0.5)*400}px`);
            p.style.setProperty('--ty', `${-(Math.random()*200+100)}px`);
            p.style.setProperty('--rot', `${Math.random()*720}deg`);
            container.appendChild(p);
            setTimeout(() => p.remove(), 1000);
        }
    }
    
    showMenu();
</script>
</body>
</html>